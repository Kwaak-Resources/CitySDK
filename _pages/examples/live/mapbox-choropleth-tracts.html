---
permalink: /examples/live/mapbox-choropleth-tracts/
---

<html>

<head>
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.js"></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v2.0.1/mapbox-gl.css' rel='stylesheet' />
  <script src="{{ '/assets/citysdk.js' | relative_url }}"></script>
</head>

<body>
  <style>
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
  </style>
  <div id="map"></div>
  <script>
    mapboxgl.accessToken =
      "pk.eyJ1Ijoib3BlbmlkZW8iLCJhIjoiY2pnemR0dmwyMHVhdDJ2bGV1bnl6amJqaiJ9._G3sOFQoJZklpO9pscg1mw";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: {
        lat: 38.5118,
        lng: -120.67006
      },
      zoom: 8.5
    });

    map.on("load", () => {
      //setup source and layer
      map.addSource("tracts", {
        type: "vector",
        tiles: ["https://gis.data.census.gov/arcgis/rest/services/Hosted/VT_2019_140_00_PY_D1/VectorTileServer/tile/{z}/{y}/{x}.pbf"],
        promoteId: "GEOID" // promote field to be used as a foreign key
      })

      map.addLayer({
        id: "tracts-fill",
        type: "fill",
        source: "tracts",
        "source-layer": "CensusTract",
        paint: {
          "fill-opacity": 0.8,
          "fill-color": "grey"
        }
      });

      map.addLayer({
        id: "tracts-outline",
        type: "line",
        source: "tracts",
        "source-layer": "CensusTract",
        paint: {
          "line-color": "grey",
          "line-width": 1,
          "line-opacity": 0.3
        }
      });

      //query using citysdk
      census(
        {
          vintage: 2019,
          geoHierarchy: {
            state: "06",
            tract: "*"
          },
          sourcePath: ["acs", "acs5"],
          values: ["NAME", "B08134_001E", "B08134_011E"],
          statsKey: "3c04140849164b373c8b1da7d7cc8123ef71b7ab"
        },
        (error, response) => {
          //bind data to source layer
          response.forEach((row) => {
            const GEOID = row.state + row.county + row.tract
            map.setFeatureState({
              source: "tracts",
              sourceLayer: "CensusTract",
              //promote field to be used as the primary key
              id: GEOID
            }, {
              //promote fields to be styled or interacted with
              name: row.NAME,
              car_truck_van_count: row.B08134_011E,
              total: row.B08134_001E,
              value: row.B08134_011E / row.B08134_001E
            })
          })

          //update paint to display choropleth
          map.setPaintProperty("tracts-fill", "fill-color", [
            "interpolate",
            ["linear"],
            ["feature-state", "value"],
            0.3,
            "#fef0d9",
            0.6,
            "#fdcc8a",
            0.8,
            "#fc8d59",
            0.9,
            "#e34a33",
            1,
            "#b30000"
          ]);

          //hide tracts without values
          map.setPaintProperty("tracts-fill", "fill-opacity", [
            "case",
            ["to-boolean", ["feature-state", "value"]],
            0.6,
            0
          ]);

          map.on("click", "tracts-fill", e => {
            const features = map.queryRenderedFeatures(e.point, { layers: ["tracts-fill"] });

            if (features.length > 0) {
              const { state, properties } = features[0]

              const percent = `${(state.value * 100).toFixed(2)}%`

              if (state.value) { //only show popup if there is a value
                new mapboxgl.Popup()
                  .setLngLat(e.lngLat)
                  .setHTML(`Percent of people in <strong>${state.name}</strong> that travel to work using a car/truck/van: ${percent}`)
                  .addTo(map);
              }
            }
          });

        })
    });
  </script>
</body>

</html>